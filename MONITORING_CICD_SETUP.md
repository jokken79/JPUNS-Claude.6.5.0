# JPUNS FASE 5 - CI/CD & Monitoring Setup Guide

**Version**: 1.0
**Date**: 2025-11-22
**Status**: âœ… Ready for Implementation

---

## ğŸ“‹ Quick Start

### Option 1: Full Automated Setup (30 minutes)
```bash
# Clone repository
git clone <repo-url>
cd JPUNS-Claude.6.0.2

# Start monitoring stack (Prometheus + Grafana)
cd monitoring
docker-compose up -d

# GitHub Actions is already configured
# Just push to main branch and tests will run automatically
git push origin main
```

### Option 2: Manual Setup
Follow the detailed guides below.

---

## ğŸ”„ Part C: GitHub Actions CI/CD Pipeline

### ğŸ“ File: `.github/workflows/ci-cd-pipeline.yml`

**What it does:**
- âœ… Runs backend tests on every push
- âœ… Runs E2E tests on every push
- âœ… Builds Docker images on main branch
- âœ… Deploys to staging automatically
- âœ… Performs code quality checks (mypy, black, pylint)
- âœ… Security scanning with Trivy

### Setup Steps

#### Step 1: Enable GitHub Actions
```bash
# Actions are enabled by default in GitHub repositories
# Just ensure workflow file is in .github/workflows/
ls -la .github/workflows/
```

#### Step 2: Add Secrets to GitHub
```bash
# Go to: Settings > Secrets and variables > Actions

Required secrets:
  SLACK_WEBHOOK         # For notifications (optional)
  STAGING_DEPLOY_KEY    # SSH key for staging deployment
  GITHUB_TOKEN          # Auto-generated by GitHub
```

#### Step 3: Workflow Triggers
```yaml
# Automatically triggered on:
- Push to main branch
- Push to feature branches (claude/*)
- Pull requests to main

# Manual trigger:
# Go to Actions tab > Select workflow > Run workflow
```

### Pipeline Stages

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. BACKEND TESTS (10 min)                              â”‚
â”‚     â€¢ Integration tests (23)                            â”‚
â”‚     â€¢ Performance tests (15)                            â”‚
â”‚     â€¢ Edge case tests (25)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. FRONTEND E2E TESTS (12 min)                         â”‚
â”‚     â€¢ KEITOSAN workflows (12)                           â”‚
â”‚     â€¢ TANTOSHA workflows (15)                           â”‚
â”‚     â€¢ Role permissions (15)                             â”‚
â”‚     â€¢ Integration flows (10)                            â”‚
â”‚     â€¢ Navigation & UI (18)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. CODE QUALITY CHECKS (5 min)                         â”‚
â”‚     â€¢ Type checking (mypy)                              â”‚
â”‚     â€¢ Code formatting (black)                           â”‚
â”‚     â€¢ Linting (pylint)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. SECURITY SCANNING (5 min)                           â”‚
â”‚     â€¢ Vulnerability scan (Trivy)                        â”‚
â”‚     â€¢ Dependency check                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. BUILD ARTIFACTS (8 min) - Only on main              â”‚
â”‚     â€¢ Build Docker backend image                        â”‚
â”‚     â€¢ Build Docker frontend image                       â”‚
â”‚     â€¢ Push to GitHub Container Registry                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. DEPLOY TO STAGING (5 min) - Only on main            â”‚
â”‚     â€¢ Deploy backend image                              â”‚
â”‚     â€¢ Deploy frontend image                             â”‚
â”‚     â€¢ Notify Slack of deployment                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOTAL TIME: ~45 minutes for full pipeline
```

### Monitoring the Pipeline

```bash
# View workflow status
GitHub > Actions tab > Select workflow > View runs

# Check logs
Click on specific job > See detailed logs

# Get notifications
Slack integration sends:
  âœ… Success: Green checkmark
  âŒ Failure: Red X with error details
```

### Common Commands

```bash
# Check if workflow is valid
gh workflow list

# View recent runs
gh run list

# View specific run logs
gh run view <run-id> --log

# Trigger workflow manually
gh workflow run ci-cd-pipeline.yml --ref main
```

---

## ğŸ“Š Part D: Monitoring & Alerts (Prometheus + Grafana)

### ğŸ“ Files:
- `monitoring/prometheus.yml` - Prometheus configuration
- `monitoring/alert-rules.yml` - Alert rules
- `monitoring/alertmanager.yml` - Alert routing
- `monitoring/docker-compose.yml` - Full stack

### Quick Start

#### Step 1: Start Monitoring Stack
```bash
cd monitoring
docker-compose up -d

# Wait for services to start (30 seconds)
docker-compose ps
```

#### Step 2: Access Services
```bash
# Prometheus (metrics)
http://localhost:9090

# Grafana (dashboards)
http://localhost:3001
Username: admin
Password: admin_password_123

# Alertmanager (alerts)
http://localhost:9093
```

#### Step 3: Configure Slack Notifications (Optional)
```bash
# Get Slack webhook URL:
# Slack > Apps > Incoming Webhooks > Create New Webhook

# Update alertmanager.yml:
slack_api_url: 'YOUR_SLACK_WEBHOOK_URL'

# Restart Alertmanager:
docker-compose restart alertmanager
```

### What Gets Monitored

```
âœ… API PERFORMANCE
   â€¢ Response time (uncached, cached)
   â€¢ Error rate
   â€¢ Request volume
   â€¢ Cache hit rate

âœ… DATABASE
   â€¢ Connection count
   â€¢ Query performance
   â€¢ Slow queries
   â€¢ Availability

âœ… CACHE (Redis)
   â€¢ Hit rate
   â€¢ Memory usage
   â€¢ Key expiration
   â€¢ Availability

âœ… SYSTEM
   â€¢ CPU usage
   â€¢ Memory usage
   â€¢ Disk space
   â€¢ Network I/O

âœ… YUKYU ENDPOINTS
   â€¢ /api/dashboard/yukyu-trends-monthly
   â€¢ /api/dashboard/yukyu-compliance-status
```

### Alert Rules (20+ rules configured)

#### ğŸ”´ Critical Alerts (Immediate Action Required)
- Database is down
- Backend API is down
- Frontend is down
- High error rate (>5%)
- Critical CPU usage (>95%)
- Critical memory usage (>95%)
- Very slow API response (>5s)

#### ğŸŸ¡ Warning Alerts (Monitor)
- High error rate (>1%)
- Slow API response (>1s)
- High database connections (>80%)
- Slow database queries detected
- High CPU usage (>80%)
- High memory usage (>85%)
- High disk usage (<15% free)
- Low cache hit rate (<30%)

### Prometheus Queries (Examples)

```promql
# API Response Time (95th percentile)
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# Error Rate
rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])

# Cache Hit Rate
redis_keyspace_hits_total / (redis_keyspace_hits_total + redis_keyspace_misses_total)

# Database Connections
pg_stat_activity_count

# CPU Usage
100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# Memory Usage (percentage)
(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100
```

### Grafana Dashboards (Create These)

#### Dashboard 1: JPUNS Overview
- Status of all services
- Error rate trend
- Request volume
- Active users

#### Dashboard 2: Performance
- API response time
- Cache effectiveness
- Database query time
- 95th/99th percentiles

#### Dashboard 3: System Health
- CPU usage
- Memory usage
- Disk space
- Network I/O

#### Dashboard 4: Yukyu Specific
- Endpoint availability
- Request volume per endpoint
- Error rate per endpoint
- Response time per endpoint

#### Dashboard 5: Alerts Status
- Active alerts
- Alert trend
- Alert resolution time
- Firing vs Resolved

### Runbook Examples

#### Alert: High Error Rate
```
1. Check error logs:
   docker logs jpuns-backend | grep ERROR | tail -20

2. View affected endpoints:
   Prometheus: rate(http_requests_total{status=~"5.."}[5m])

3. Check database:
   psql jpuns_production -c "SELECT * FROM errors ORDER BY created_at DESC LIMIT 10;"

4. If database issue: Restart PostgreSQL
   docker-compose restart postgres

5. If API issue: Restart backend
   docker-compose restart jpuns-backend

6. Monitor recovery in Grafana
```

#### Alert: Database Down
```
1. Check database status:
   docker-compose ps postgres

2. Check logs:
   docker logs jpuns-postgres-monitoring

3. Restart database:
   docker-compose restart postgres

4. Verify connectivity:
   psql jpuns_production -c "SELECT 1;"

5. Alert should auto-resolve when database responds
```

#### Alert: High Memory Usage
```
1. Check which process uses memory:
   docker stats

2. If backend: Restart with cleanup
   docker-compose restart jpuns-backend

3. If database: Analyze slow queries
   Prometheus: pg_slow_queries_total

4. If Redis: Check for cache memory leaks
   redis-cli INFO memory

5. If system: Increase available memory or optimize queries
```

### Stopping Monitoring Stack

```bash
# Stop all services but keep data
docker-compose stop

# Stop and remove (lose data)
docker-compose down

# Remove everything including volumes (WARNING: loses all metrics!)
docker-compose down -v
```

---

## ğŸ”— Integration Points

### Backend Integration (FastAPI)
```python
# Add to main.py to expose metrics endpoint
from prometheus_fastapi_instrumentator import Instrumentator

Instrumentator().instrument(app).expose(app)

# Endpoint: /metrics
```

### Frontend Integration (Next.js)
```typescript
// Add custom metrics to pages
import { reportWebVitals } from 'next/web-vitals'

reportWebVitals((metric) => {
  // Send to Prometheus push gateway or StatsD
  console.log(metric)
})
```

---

## ğŸ“ˆ SLA Targets

Based on monitoring, ensure:

```
âœ… API Availability: 99.9% (max 43 min downtime/month)
âœ… Response Time (95th): <500ms for cached, <1000ms uncached
âœ… Error Rate: <1% (99% success rate)
âœ… Cache Hit Rate: >50%
âœ… Database Availability: 99.95%
âœ… Page Load Time: <3 seconds
```

---

## ğŸ› ï¸ Maintenance

### Weekly
- [ ] Review alert trends
- [ ] Check disk space usage
- [ ] Review slow query logs
- [ ] Validate backup integrity

### Monthly
- [ ] Analyze performance trends
- [ ] Update alert thresholds if needed
- [ ] Capacity planning review
- [ ] Disaster recovery drill

### Quarterly
- [ ] Full system audit
- [ ] Performance optimization review
- [ ] Security assessment
- [ ] Documentation update

---

## ğŸ“ Support

### Troubleshooting

**Prometheus not scraping targets:**
```bash
# Check Prometheus logs
docker logs jpuns-prometheus | grep ERROR

# Verify targets in Prometheus UI
http://localhost:9090/targets
```

**Grafana not showing data:**
```bash
# Check datasource connection
Settings > Data Sources > Prometheus > Test Connection

# If fail: Verify prometheus is running
docker-compose ps prometheus
```

**Alertmanager not sending Slack messages:**
```bash
# Check webhook URL in alertmanager.yml
# Test webhook manually:
curl -X POST -H 'Content-type: application/json' \
  --data '{"text":"Test"}' \
  YOUR_SLACK_WEBHOOK_URL
```

---

## ğŸ“š Next Steps

1. âœ… Create Grafana dashboards (30 min)
2. âœ… Configure Slack webhooks (5 min)
3. âœ… Test alert firing (10 min)
4. âœ… Create runbooks for alerts (30 min)
5. âœ… Train ops team (1 hour)

---

**Status**: âœ… READY FOR PRODUCTION
**Document Version**: 1.0
**Last Updated**: 2025-11-22
